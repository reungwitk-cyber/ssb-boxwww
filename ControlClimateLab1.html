<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LAB BOX ‚Äì Control Climate</title>

    <!-- =======================
       üîΩ SWITCH DROPDOWN LAB BOX 
       Bootstrap CSS
       ======================= -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ======================= -->

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f0f2f5;
            --panel: #fff;
            --ink: #121619;
            --muted: #6b7280;
            --brand: #b7f36a;
            --accent: #9ad83f;
            --sidebar: #fff;
            --sidebar-border: #cde88b;
            --tab-height: 40px;
            --sidebar-width: 220px;
            --ring-bg: #e5e7eb;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
            color: var(--ink);
            background: var(--bg)
        }

        .app {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh
        }

        /* Topbar */
        .topbar {
            grid-column: 1/-1;
            background: var(--panel);
            border-bottom: 1px solid #e5e7eb;
            position: relative
        }

        .topbar-inner {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 16px
        }

        .brand-logo {
            height: 34px
        }

        .title {
            background: var(--panel);
            border: 1px solid var(--sidebar-border);
            padding: 0 12px;
            border-radius: 6px;
            font-weight: 700;
            margin-right: 10px;
            font-size: 22px;
            color: #0f172a;
            letter-spacing: .5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .08)
        }

        .tabs {
            flex: 1;
            display: flex;
            align-items: flex-end;
            height: var(--tab-height);
            background: var(--brand);
            border-left: 1px solid var(--sidebar-border);
            border-right: 1px solid var(--sidebar-border);
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            overflow-x: auto;
            scrollbar-width: none
        }

        .tabs::-webkit-scrollbar {
            display: none
        }

        .tab {
            position: relative;
            height: var(--tab-height);
            line-height: var(--tab-height);
            padding: 0 18px;
            font-size: 13px;
            color: #1f2937;
            cursor: pointer;
            user-select: none
        }

        .tab.active {
            font-weight: 600;
            border-bottom: 3px solid #3a3a3a
        }

        .tab:hover {
            background: rgba(0, 0, 0, .04)
        }

        .clock {
            position: absolute;
            right: 14px;
            top: 8px;
            text-align: right;
            font-size: 13px
        }

        .clock .date,
        .clock .time {
            font-weight: 700
        }

        .topbar-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .topbar-right .clock {
            position: static
        }

        .darklight {
            margin-left: auto;
            padding: 6px 12px;
            border-radius: 20px;
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: .2s;
            border: 1px solid #e2e8f0
        }

        .darklight:hover {
            background: #e2e8f0
        }

        /* Sidebar */
        .sidebar {
            grid-row: 2/-1;
            background: var(--sidebar);
            border-right: 2px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            min-width: 0
        }

        .menu {
            padding: 8px 8px 18px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .menu-btn {
            display: grid;
            grid-template-columns: 44px 1fr;
            align-items: center;
            gap: 10px;
            padding: 10px 8px;
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            text-align: left;
            background: #fff;
            transition: .2s ease;
            color: #111
        }

        .menu-btn:hover {
            border-color: var(--accent);
            background: #fafff1
        }

        .menu-btn.active {
            background: #eaffc8;
            border-color: var(--accent);
            font-weight: 600
        }

        .ico img {
            width: 40px;
            height: 40px;
            display: block
        }

        .side-section {
            padding: 10px 14px;
            font-size: 13px;
            color: #111;
        }

        /* Content */
        .content {
            grid-column: 2/-1;
            grid-row: 2/-1;
            background: var(--panel);
            margin: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .05);
            border: 1px solid #e5e7eb
        }

        .content-inner {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: min-content;
            gap: 12px;
            padding: 0;
            border-left: 1px solid var(--accent)
        }

        .content-inner>.tabs {
            grid-column: 1/-1
        }

        /* Left card + gauges */
        .control-climate {
            padding: 10px 40px 10px
        }

        .control-climate .rowA {
            display: grid;
            grid-template-columns: 250px minmax(0, 1fr);
            /* ‡πÉ‡∏™‡πà minmax(0,1fr) ‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡∏±‡∏ô‡∏Å‡∏£‡∏¥‡∏î‡∏•‡πâ‡∏ô */
            gap: 16px;
            align-items: start;
            width: 100%;

        }

        .control-climate .rowB {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px
        }

        /* ‡∏Ñ‡∏∑‡∏≠ css ‡πÅ‡∏ö‡∏ö‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á control-climate  */
        .content-inner>.control-climate {
            grid-column: 1 / -1;
            /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏¥‡∏î 1 ‡∏ñ‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */
        }

        /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ô .icon1 */
        .icon1 img {
            width: 65px;
            height: 65px;
            object-fit: contain;
            /* ‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ö‡∏¥‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô */
            display: block;
            /* ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á img */
            margin: 6px;
            /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏£‡∏≠‡∏ö ‡πÜ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á) */
            border-radius: 6px;
            /* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á */
        }







        .cc-card {
            background: #fff;
            border: 1px solid var(--ring-bg);
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
            font-size: 13px
        }

        .cc-card .h {
            background: #cfe2ff;
            padding: 3px;
            border-radius: 3px;
            font-weight: 700;
            font-size: 14px
        }

        .cc-card .head {
            display: grid;
            grid-template-columns: 40px 1fr;
            gap: 40px;
            align-items: center
        }

        .cc-card .row1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
            margin: 6px 0;
            background: #f0f7f9;
            border-radius: 6px;
            padding: 5px
        }

        .divider {
            border-top: 1px dashed var(--ring-bg);
            margin: 2px 0 2px
        }



        /* =======================
       ‚òÖ ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (gauge) ‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏î‡∏¥‡∏°)
       - ‡πÉ‡∏ä‡πâ grid + conic-gradient ‡∏ó‡∏≥ progress
       ======================= */
        .gauges {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            padding: 12px;
        }

        .gauge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .gauge .ring {
            --size: 132px;
            --track: #e5e7eb;
            --progress: #6ee7b7;
            width: var(--size);
            height: var(--size);
            border-radius: 50%;
            position: relative;
            display: grid;
            place-items: center;
            background:
                radial-gradient(#fff calc(50% - 10px), transparent calc(50% - 9px)),
                conic-gradient(var(--progress) calc(var(--p)*1%), var(--track) 0);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .08), inset 0 0 0 1px #f1f5f9;
        }

        .gauge .ring img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 px 6px rgba(0, 0, 0, .12);
            background: #fff;
            padding: none;
        }

        .gauge .value {
            position: absolute;
            bottom: 12px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
        }

        .gauge .unit {
            font-size: 12px;
            opacity: .8;
            margin-left: 2px
        }

        .gauge .label {
            font-size: 12px;
            font-weight: 600;
            color: #0f172a;
            background: #eeffcf;
            border: 1px solid #cce68f;
            padding: 4px 12px;
            border-radius: 999px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .06);
        }

        /* ‡∏™‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ gauge ‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏î‡∏¥‡∏°) */
        #gAir .ring {
            --progress: #f87171
        }

        /* Temp */
        #gRH .ring {
            --progress: #34d399
        }

        /* RH */
        #gCO2 .ring {
            --progress: #fb923c
        }

        /* 3 columns below (placeholders) */
        .rowB {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-top: 16px
        }

        .ctrl-row {
            display: grid;
            grid-template-columns: 28px 1fr auto;
            gap: 20px;
            align-items: center;
            margin: 6px
        }







        .light-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 6px
        }

        .lamp-row {
            display: grid;
            grid-template-columns: 60px 60px auto auto auto 60px;
            gap: 8px;
            align-items: center;
            margin: 4px 0
        }

        .sp-row {
            display: grid;
            grid-template-columns: 28px 1fr auto auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;

        }

        .icon-sm {
            width: 42px;
            height: 42px;
            object-fit: contain;
            padding: 4px;
        }

        .icon-smd {
            width: 80px;
            height: 45px;
            object-fit: contain;
            padding: 2px;
        }

        .muted {
            color: var(--muted)
        }

        @media (max-width:1100px) {
            .control-climate .rowA {
                grid-template-columns: 1fr
            }

            .rowB {
                grid-template-columns: 1fr
            }

            .gauges {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        /* =======================
       ‚òÖ Dropdown style (‡πÄ‡∏î‡∏¥‡∏°)
       ======================= */
        .sidebar .dropdown .btn {
            background: #ffffff;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all .3s ease;
            width: 100%;
            text-align: left;
        }

        .sidebar .dropdown .btn:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
        }

        .sidebar .dropdown-menu {
            border-radius: 12px;
            border: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            animation: fadeIn .3s ease;
            width: 100%;
            z-index: 1000;
        }

        .sidebar .dropdown-item {
            font-weight: 500;
            padding: 10px 20px;
            transition: all .2s ease;
        }

        .sidebar .dropdown-item:hover {
            background-color: #fda085;
            color: #fff;
            border-radius: 8px;
        }

        /* =======================
       ‚òÖ‡∏à‡∏ö Dropdown style (‡πÄ‡∏î‡∏¥‡∏°)
       ======================= */

        /* ======================
       ‚òÖ Dropdown style (auto)
       ======================= */
        .vitsidebar .dropdown .btn {
            background: #bcf1c3;
            border-radius: 12px;
            font-weight: bold;

            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all .3s ease;
            width: 100%;
            text-align: left;
        }

        .vitsidebar .dropdown .btn:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
        }

        .vitsidebar .dropdown-menu {
            border-radius: 12px;
            border: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            animation: fadeIn .3s ease;
            width: 100%;
            z-index: 1000;
        }

        .vitsidebar .dropdown-item {
            font-weight: 500;
            padding: 10px 20px;
            transition: all .2s ease;
        }

        .vitsidebar .dropdown-item:hover {
            background-color: #fda085;
            color: #fff;
            border-radius: 8px;
        }

        /* =======================
       ‚òÖ‡∏à‡∏ö Dropdown style (‡πÄ‡∏î‡∏¥‡∏°)
       ======================= */

        /* =======================
       ‚òÖ‡πÄ‡∏£‡∏¥‡πà‡∏° css style (switch ‡πÄ‡πÄ‡∏•‡∏∞‡∏°‡∏µ‡∏ö‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å Bootstrap)
       ======================= */

        /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏±‡∏ö‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
        .switch-inline {
            display: flex;
            align-items: center;
            /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            gap: var(--switch-gap, 8px);
            /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå-‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ) */
        }

        /* (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÑ‡∏î‡πâ */
        .switch-lg.form-check-input {
            width: 3.3rem;
            height: 1.3rem;
        }

        .form-switch .form-check-input:checked {
            background-color: #9cf791;
            /* */
            border-color: #7cff09;
        }

        /* =======================
       ‚òÖ‡∏à‡∏ö css style (switch ‡πÄ‡πÄ‡∏•‡∏∞‡∏°‡∏µ‡∏ö‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å Bootstrap)
       ======================= */
        /* =======================
       ‚òÖ‡πÄ‡∏£‡∏¥‡πà‡∏° css style (lamp auto manaul task off Bootstrap)
       ======================= */

        .pill.auto {
            background: #dcf8bc;
            color: #000;
        }

        .pill.manual {
            background: #e54b4b;
            color: #fff;
        }

        .pill.task {
            background: #f7c708;
            color: #000;
        }

        .pill.off {
            background: #f3f3f3;
            color: #000;
        }

        .pill {
            min-height: 18px;

            flex: 0 1 200px;
            /* ‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100px */
        }

        /* =======================
       ‚òÖ‡∏à‡∏ö css style (lamp auto manaul task off Bootstrap)
       ======================= */

        /* =======================
       ‚òÖ‡πÄ‡∏£‡∏¥‡∏° css ‡∏à‡∏≤‡∏á switch On/Off ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î
       ======================= */

        /* ‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏° */
        .switch-inline.is-pending {
            opacity: .5;
            pointer-events: none;
        }

        /* ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏µ‡∏ü‡∏µ‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ: */
        .form-check-input.is-pending {
            opacity: .6;
            cursor: wait;
        }

        /* =======================
       ‚òÖ‡∏à‡∏ö css ‡∏à‡∏≤‡∏á switch On/Off ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î
       ======================= */
        /* =======================
       ‚òÖ‡πÄ‡∏£‡∏¥‡πà‡∏° css ‡∏à‡∏≤‡∏á mode auto manaul task ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î
       ======================= */
        /* MODE pending: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ */


        /* ‡∏õ‡∏∏‡πà‡∏° MODE: ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏ä‡∏±‡∏ô‡∏ô‡∏¥‡πà‡∏° ‡πÜ */
        #modeDropdown .btn {
            font-weight: 700;
            border-radius: 12px;
            border: 1px solid transparent;
            transition: background-color .2s ease, color .2s ease, filter .15s ease, opacity .15s ease;
        }

        /* ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î */
        #modeDropdown .btn.mode-auto {
            background: #dcf8bc;
            color: #0f172a;
            border-color: #cce68f;
        }

        #modeDropdown .btn.mode-manual {
            background: #e54b4b;
            color: #fff;
            border-color: #c73b3b;
        }

        #modeDropdown .btn.mode-task {
            background: #f7c708;
            color: #000;
            border-color: #deb600;
        }

        #modeDropdown .btn.mode-off {
            background: #f3f3f3;
            color: #000;
            border-color: #e5e7eb;
        }

        /* ‡∏ï‡∏≠‡∏ô‡∏£‡∏≠ state ‡πÉ‡∏´‡πâ‡∏à‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏û‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≥) */
        #modeDropdown .btn.is-pending {
            opacity: .6;
            pointer-events: none;
            filter: grayscale(30%);
        }
    </style>


</head>

<body>
    <div class="app">
        <!-- Topbar -->
        <header class="topbar">
            <div class="topbar-inner">
                <div class="brand-badge">
                    <img src="https://github.com/reungwitk-cyber/ssb-box/raw/c958231f7e20c74bff3076384c1e46bbee9eec24/Logosbb-box.png"
                        alt="SABIENG BOX Logo" class="brand-logo">
                </div>
                <div class="title">LAB BOX</div>
                <div class="topbar-right">

                    <div class="dropdown" id="modeDropdown">
                        <button class="btn dropdown-toggle px-5 py-0" type="button" data-bs-toggle="dropdown">
                            MODE
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-val="1">AUTO</a></li>
                            <li><a class="dropdown-item" href="#" data-val="0">MANUAL</a></li>
                            <li><a class="dropdown-item" href="#" data-val="2">TASK</a></li>
                        </ul>
                    </div>



                    <button class="darklight">darklight</button>
                    <div class="clock">
                        <div class="date" id="dateText"></div>
                        <div class="time" id="timeText"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="menu" style="padding-top:10px">
                <button class="menu-btn active"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/c958231f7e20c74bff3076384c1e46bbee9eec24/homesw1.png"
                            alt="Home"></span><span>Sabieng HQ</span></button>
            </div>
            <div class="side-section">
                <div class="dropdown">
                    <button class="btn dropdown-toggle px-4 py-2" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">‚öôÔ∏è LAB BOX</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="Labbox.html">LABBOX</a></li>
                        <li><a class="dropdown-item" href="single.html">SINGLE</a></li>
                        <li><a class="dropdown-item" href="double.html">DOUBLE</a></li>
                    </ul>
                </div>
            </div>
            <div class="menu">
                <button class="menu-btn"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/695cd88b6d596bfbd2b4bb6e83b47e81ab779a1f/RecipeSw.png"
                            alt="Recipes"></span><span>Recipes</span></button>
                <button class="menu-btn"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/cf3649fc297bab4602cac39e05810940d42b774f/Crop%20yield.png"
                            alt="Crop scheduling"></span><span>Crop scheduling</span></button>
                <button class="menu-btn"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/cf3649fc297bab4602cac39e05810940d42b774f/Crop%20scheduling.png"
                            alt="Crop yield"></span><span>Crop yield</span></button>
                <button class="menu-btn"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/cf3649fc297bab4602cac39e05810940d42b774f/Energy%20Management.png"
                            alt="Energy"></span><span>Energy Management</span></button>
                <button class="menu-btn"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/cf3649fc297bab4602cac39e05810940d42b774f/SettingSw1.png"
                            alt="Settings"></span><span>Setting</span></button>
                <button class="menu-btn"><span class="ico"><img
                            src="https://github.com/reungwitk-cyber/ssb-box/raw/cf3649fc297bab4602cac39e05810940d42b774f/Help.png"
                            alt="Help"></span><span>Help</span></button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <div class="content-inner">
                <nav class="tabs">
                    <div class="tab" data-href="DashboardLab1.html">Dashboard</div>
                    <div class="tab active">Control Climate</div>
                    <div class="tab">Control Nutrients</div>
                    <div class="tab">Recipe</div>
                    <div class="tab">Notification</div>
                    <div class="tab">Analysis</div>
                </nav>

                <section class="control-climate">
                    <div class="rowA">
                        <!-- left card -->
                        <div class="cc-card">
                            <div class="h">Farm Climate</div>
                            <div class="head">
                                <div class="icon1">
                                    <img src="https://github.com/reungwitk-cyber/ssb-box/raw/df1df5666319cad318b28f4e81c9e03b222ea3cc/recipe2.svg"
                                        alt="">
                                </div>
                                <div>
                                    <div class="muted">Recipe name</div>
                                    <div id="clm-name" style="font-weight:600">Leafy Green 1</div>
                                </div>
                            </div>
                            <div class="divider"></div>
                            <div class="row1"><span>Air temp</span><span>= <b id="clm-air">25.0</b> ¬∞C</span></div>
                            <div class="row1"><span>RH%</span><span>= <b id="clm-rh">70</b> %</span></div>
                            <div class="row1"><span>CO‚ÇÇ</span><span>= <b id="clm-co2">1200</b> ppm</span></div>
                            <div class="row1"><span>Light</span><span>= <b id="clm-light">ON</b></span></div>
                        </div>

                        <!-- gauges -->
                        <section class="gauges">
                            <div class="gauge" id="gAir" data-min="0" data-max="40" data-precision="1" data-r1="20"
                                data-r2="27" data-c1="#3bddf6" data-c2="#5afab2" data-c3="#fc6453">
                                <div class="ring" style="--p:0">
                                    <img src="https://github.com/reungwitk-cyber/ssb-box/raw/497513610937edbe8884a21c7b8c3d916d96a5b7/icon%20temp.png"
                                        alt="Air temp">
                                    <div class="value"><span class="num">30</span><span class="unit">¬∞C</span></div>
                                </div>
                                <div class="label">Air temp</div>
                            </div>

                            <!-- RH -->
                            <div class="gauge" id="gRH" data-min="0" data-max="100" data-precision="1" data-r1="60"
                                data-r2="80" data-c1="#3bddf6" data-c2="#5afab2" data-c3="#fc6453">
                                <div class="ring" style="--p:0">
                                    <img src="https://github.com/reungwitk-cyber/ssb-box/raw/497513610937edbe8884a21c7b8c3d916d96a5b7/RH%20ICON.png"
                                        alt="RH">
                                    <div class="value"><span class="num">55</span><span class="unit">%</span></div>
                                </div>
                                <div class="label">RH%</div>
                            </div>

                            <!-- CO2 -->
                            <div class="gauge" id="gCO2" data-min="0" data-max="2200" data-precision="0" data-r1="1000"
                                data-r2="1200" data-c1="#3bddf6" data-c2="#5afab2" data-c3="#fc6453">
                                <div class="ring" style="--p:0">
                                    <img src="https://github.com/reungwitk-cyber/ssb-box/raw/497513610937edbe8884a21c7b8c3d916d96a5b7/CO2.png"
                                        alt="CO‚ÇÇ">
                                    <div class="value"><span class="num">1200</span><span class="unit">ppm</span></div>
                                </div>
                                <div class="label">CO‚ÇÇ</div>
                            </div>

                            <!-- Light (ON/OFF ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ) -->
                            <div class="gauge" id="gLight" data-min="0" data-max="1">
                                <div class="ring" style="--p:0">
                                    <img src="https://github.com/reungwitk-cyber/ssb-box/raw/497513610937edbe8884a21c7b8c3d916d96a5b7/Light.png"
                                        alt="Light">
                                    <div class="value"><span class="num">ON</span></div>
                                </div>
                                <div class="label">Light</div>
                            </div>
                        </section>
                    </div>

                    <!-- RowB placeholders -->
                    <div class="rowB">
                        <div class="cc-card">
                            <div class="h">Climate Controls</div>
                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/AirS0.svg"
                                    alt="Air conditioner" data-state-alias="aircon"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/6934e97808b5e5fe762fb3f1173ea4a6fe2e2ad8/AirS1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/AirS0.svg">
                                <span>Air conditioner</span>
                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="airconSwitch" data-alias="aircon">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>
                            </div>

                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Humidifilers0.svg"
                                    alt="Humidifier" data-state-alias="humidifier"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/6934e97808b5e5fe762fb3f1173ea4a6fe2e2ad8/Humidifilers1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Humidifilers0.svg">
                                <span>Humidifier</span>
                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="humidifierSwitch" data-alias="humidifier">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>
                            </div>

                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/497513610937edbe8884a21c7b8c3d916d96a5b7/CO2.png"
                                    alt="CO‚ÇÇ injection" data-state-alias="co2"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/1b4a0f4fd8a36f160e7f41728d7c161a1e10899c/Co2S1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/497513610937edbe8884a21c7b8c3d916d96a5b7/CO2.png">
                                <span>CO‚ÇÇ injection</span>
                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="co2Switch" data-alias="co2">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>


                            </div>
                            <div class="ctrl-row d-flex align-items-center">
                                <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô + ‡∏ä‡∏∑‡πà‡∏≠ -->
                                <div class="d-flex align-items-center me-3">
                                    <img class="icon-sm state-img"
                                        src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Fans0.svg"
                                        alt="Duct fan" data-state-alias="ductfan"
                                        data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/6934e97808b5e5fe762fb3f1173ea4a6fe2e2ad8/Fans1.svg"
                                        data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Fans0.svg"
                                        width="48" height="48">
                                    <span class="ms-2 fw-semibold">Duct fan</span>
                                </div>

                                <!-- ‡∏Å‡∏•‡∏≤‡∏á: Pill ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
                                <!-- ductfan -->
                                <div class="pill off text-center py-2 mx-3 rounded-pill shadow-sm w-25"
                                    id="pill-ductfan" data-alias="ductfan" data-switch-key="ductfanof"
                                    data-mode-topic="ssb-box/mode/ductfan/state"
                                    data-cmd-topic="ssb-box/switch/ductfanof/cmd"
                                    data-switch-state-topic="ssb-box/switch/ductfanof/state">
                                    <span data-label>Off</span>
                                </div>

                                <!-- ‡∏Ç‡∏ß‡∏≤: Switch On/Off -->
                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="ductfanSwitch" data-alias="ductfan">
                                    </div>
                                    <label class="form-check-label mb-0 ms-1" for="ductfanSwitch">On/Off</label>
                                </div>
                            </div>

                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/ReturnFanS0.svg"
                                    alt="Return fan" data-state-alias="returnfan"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/1b4a0f4fd8a36f160e7f41728d7c161a1e10899c/ReturnFanS1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/ReturnFanS0.svg">
                                <span>Return fan</span>

                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="returnfanSwitch" data-alias="returnfan">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>



                            </div>

                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/ExhaustS0.svg"
                                    alt="Exhaust fan" data-state-alias="exhaustfan"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/1b4a0f4fd8a36f160e7f41728d7c161a1e10899c/ExhaustS1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/ExhaustS0.svg">
                                <span>Exhaust fan</span>

                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="exhaustfanSwitch" data-alias="exhaustfan">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>
                            </div>

                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Fans0.svg"
                                    alt="Nursery Fan : Upper" data-state-alias="nurseryfanupper"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/6934e97808b5e5fe762fb3f1173ea4a6fe2e2ad8/Fans1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Fans0.svg">
                                <span>Nursery Fan : Upper</span>
                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="nurseryfanupperSwitch" data-alias="nurseryfanupper">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>



                            </div>

                            <div class="ctrl-row">
                                <img class="icon-sm state-img"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Fans0.svg"
                                    alt="Nursery Fan : Lower" data-state-alias="nurseryfanlower"
                                    data-src-on="https://github.com/reungwitk-cyber/ssb-box/raw/6934e97808b5e5fe762fb3f1173ea4a6fe2e2ad8/Fans1.svg"
                                    data-src-off="https://github.com/reungwitk-cyber/ssb-box/raw/57c00370db4344094aa6c268bb5f5505f1259332/Fans0.svg">
                                <span>Nursery Fan : Lower</span>
                                <div class="switch-inline" style="--switch-gap: 10px;">
                                    <div class="form-check form-switch m-0">
                                        <!-- üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° class="ssbbox-switch" ‡πÅ‡∏•‡∏∞ data-alias -->
                                        <input class="form-check-input switch-lg ssbbox-switch" type="checkbox"
                                            id="nurseryfanlowerSwitch" data-alias="nurseryfanlower">
                                    </div>
                                    <label class="form-check-label mb-0">On/Off</label>
                                </div>
                            </div>

                        </div>

                        <div class="cc-card">
                            <div class="h">Light Setting</div>
                            <div class="light-row"><img class="icon-smd"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/60952953ff1871957cf5642ee8436ad318649e5a/Dayicon.svg"
                                    alt=""><span>Start <input type="time" value="06:00"></span><span>End
                                    <input type="time" value="22:00"></span><b>16 Hrs</b></div>
                            <div class="light-row"><img class="icon-smd"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/60952953ff1871957cf5642ee8436ad318649e5a/nighticon.svg"
                                    alt=""><span>Start <input type="time" value="22:01"></span><span>End <input
                                        type="time" value="06:00"></span><b>8
                                    Hrs</b></div>
                            <div class="lamp-row"><span>Row 1</span><span>Auto</span><label><input type="checkbox">
                                    On/Off</label><span>ON <input type="time" value="00:01"></span><span>OFF <input
                                        type="time" value="16:00"></span><b>75%</b></div>
                            <div class="lamp-row"><span>Row 2</span><span>Auto</span><label><input type="checkbox">
                                    On/Off</label><span>ON <input type="time" value="00:01"></span><span>OFF <input
                                        type="time" value="16:00"></span><b>75%</b></div>
                            <div class="lamp-row"><span>Row 3</span><span>Auto</span><label><input type="checkbox">
                                    On/Off</label><span>ON <input type="time" value="00:01"></span><span>OFF <input
                                        type="time" value="16:00"></span><b>75%</b></div>
                            <div class="lamp-row"><span>Row 4</span><span>Auto</span><label><input type="checkbox">
                                    On/Off</label><span>ON <input type="time" value="00:01"></span><span>OFF <input
                                        type="time" value="16:00"></span><b>75%</b></div>
                        </div>

                        <div class="cc-card">
                            <div class="h">Climate Set point</div>
                            <div class="sp-row"><img class="icon-sm"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/136c5650822e9408fff8afce299e96f49001fb45/tempiconday.svg"
                                    alt=""><span>Day Temp.</span><input type="number" value="25"> ¬∞C</div>
                            <div class="sp-row"><img class="icon-sm"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/136c5650822e9408fff8afce299e96f49001fb45/tempiconnight.svg"
                                    alt=""><span>Night Temp.</span><input type="number" value="23"> ¬∞C</div>
                            <div class="sp-row"><img class="icon-sm"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/136c5650822e9408fff8afce299e96f49001fb45/Co2iconDay.svg"
                                    alt=""><span>CO‚ÇÇ Day</span><input type="number" value="1200"> ppm</div>

                            <div class="sp-row"><img class="icon-sm"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/136c5650822e9408fff8afce299e96f49001fb45/Humday.svg"
                                    alt=""><span>RH Day</span><input type="number" value="65"> %</div>
                            <div class="sp-row"><img class="icon-sm"
                                    src="https://github.com/reungwitk-cyber/ssb-box/raw/136c5650822e9408fff8afce299e96f49001fb45/Humnight.svg"
                                    alt=""><span>RH Night</span><input type="number" value="80"> %</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- ================= CLOCK ================= -->
    <script>
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà+‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö real-time
        const dateText = document.getElementById('dateText'),
            timeText = document.getElementById('timeText');

        function pad(n) { return String(n).padStart(2, '0'); }

        function fmt() {
            const d = new Date(), day = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            if (dateText) dateText.textContent =
                `${day[d.getDay()]}. ${pad(d.getDate())} - ${pad(d.getMonth() + 1)} - ${String(d.getFullYear()).slice(-2)}`;
            if (timeText) timeText.textContent =
                `Time - ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        fmt();
        setInterval(fmt, 1000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ================= GAUGE ================= -->
    <script>
        // ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å array ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á string ‚Üí number
        const first = (v, fb = null) =>
        (Array.isArray(v) && v.length ? Number(v[0]) :
            (Number.isFinite(Number(v)) ? Number(v) : fb));

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏µ (low, mid, high)
        function getColorRanges(el, min, max) {
            const r1 = Number(el?.dataset.r1), r2 = Number(el?.dataset.r2);
            const c1 = el?.dataset.c1 || '#3b82f6',
                c2 = el?.dataset.c2 || '#10b981',
                c3 = el?.dataset.c3 || '#ef4444';
            const cut1 = Number.isFinite(r1) ? r1 : (min + (max - min) * 0.33);
            const cut2 = Number.isFinite(r2) ? r2 : (min + (max - min) * 0.66);
            return [
                { min, max: cut1, color: c1 },
                { min: cut1, max: cut2, color: c2 },
                { min: cut2, max, color: c3 }
            ];
        }

        // ‡πÉ‡∏™‡πà‡∏™‡∏µ‡πÄ‡∏Å‡∏à‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤
        function setGaugeColor(ring, val, ranges) {
            for (const r of ranges) {
                if (val >= r.min && val <= r.max) {
                    ring?.style.setProperty('--progress', r.color);
                    return;
                }
            }
            if (ranges?.length) ring?.style.setProperty('--progress', ranges[ranges.length - 1].color);
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏à (‡∏£‡∏ß‡∏° clamp ‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏∏‡∏î‡∏ä‡πà‡∏ß‡∏á)
        function setGauge(gaugeEl, value) {
            if (!gaugeEl) return;
            const min = Number(gaugeEl.dataset.min || 0),
                max = Number(gaugeEl.dataset.max || 100);
            const ring = gaugeEl.querySelector('.ring'),
                numEl = gaugeEl.querySelector('.num');
            const nVal = Number(value);

            const clamped = Math.max(min, Math.min(max, nVal));
            const pct = Math.max(0, Math.min(1, (clamped - min) / (max - min))) * 100;
            ring?.style.setProperty('--p', pct.toFixed(2));

            if (gaugeEl.id === 'gLight') {
                if (numEl) numEl.textContent = (clamped >= 0.5) ? 'ON' : 'OFF';
                ring?.style.setProperty('--progress',
                    (clamped >= 0.5) ? (gaugeEl.dataset.c2 || '#22c55e') : (gaugeEl.dataset.c1 || '#a1a1aa'));
            } else {
                if (numEl) numEl.textContent = clamped.toFixed(Number(gaugeEl.dataset.precision || 1));
                setGaugeColor(ring, clamped, getColorRanges(gaugeEl, min, max));
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢
            if (gaugeEl.id === 'gAir') document.getElementById('clm-air').textContent = clamped.toFixed(1);
            if (gaugeEl.id === 'gRH') document.getElementById('clm-rh').textContent = clamped.toFixed(0);
            if (gaugeEl.id === 'gCO2') document.getElementById('clm-co2').textContent = clamped.toFixed(0);
            if (gaugeEl.id === 'gLight') document.getElementById('clm-light').textContent = (clamped >= 0.5 ? 'ON' : 'OFF');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏° ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô payload sensor ‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
        function handleSensorPayload(p) {
            const air = first(p.BackrooomTemp),
                rh = first(p.Backrooomhumidity),
                co2 = first(p.BackrooomCo2);
            if (air != null) setGauge(document.getElementById('gAir'), air);
            if (rh != null) setGauge(document.getElementById('gRH'), rh);
            if (co2 != null) setGauge(document.getElementById('gCO2'), co2);
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Light ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            // const light=first(p.Light); if(light!=null) setGauge(document.getElementById('gLight'), light);
        }
    </script>

    <!-- ================= DEVICE STATE ================= -->
    <script>
        const DEVICE_STATE = Object.create(null); // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ runtime ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        const MODE_STATE = Object.create(null); // üÜï ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ ssb-box/mode/<alias>/state

        // decode alias ‡∏à‡∏≤‡∏Å topic ‡πÄ‡∏ä‡πà‡∏ô ssb-box/switch/ductfan/state ‚Üí "ductfan"
        function aliasFromTopic(topic) {
            const p = String(topic || '').split('/');
            return (p.length >= 4 && p[0] === 'ssb-box' &&
                (p[1] === 'lamp' || p[1] === 'switch') &&
                p[p.length - 1] === 'state') ? p[2] : null;
        }

        // decode payload ‚Üí scalar
        function scalarFromPayload(alias, payload) {
            if (payload == null) return null;
            if (typeof payload === 'string') { try { return scalarFromPayload(alias, JSON.parse(payload)); } catch { } }
            if (Array.isArray(payload)) return payload.length ? payload[0] : null;
            if (typeof payload === 'object') {
                if (alias in payload) return Array.isArray(payload[alias]) ? payload[alias][0] : payload[alias];
                const outKey = `output-${alias}`;
                if (outKey in payload) return Array.isArray(payload[outKey]) ? payload[outKey][0] : payload[outKey];
                if ('value' in payload) return Array.isArray(payload.value) ? payload.value[0] : payload.value;
                const ks = Object.keys(payload);
                if (ks.length === 1) { let v = payload[ks[0]]; return Array.isArray(v) ? v[0] : v; }
            }
            if (typeof payload === 'boolean' || typeof payload === 'number') return payload;
            if (!Number.isNaN(Number(payload))) return Number(payload);
            if (payload === 'true') return true;
            if (payload === 'false') return false;
            return payload;
        }

        // ‡πÉ‡∏ä‡πâ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô boolean
        function toBool(v) {
            if (Array.isArray(v)) v = v[0];
            if (typeof v === 'string') {
                const s = v.toLowerCase();
                if (['true', 'on', '1'].includes(s)) return true;
                if (['false', 'off', '0'].includes(s)) return false;
            }
            if (typeof v === 'number') return v !== 0;
            return !!v;
        }

        // sync ‡∏£‡∏π‡∏õ icon
        function updateImagesByAlias(alias, val) {
            const isOn = toBool(val);
            document.querySelectorAll(`img.state-img[data-state-alias="${alias}"]`).forEach(img => {
                if (isOn && img.dataset.srcOn) img.src = img.dataset.srcOn;
                if (!isOn && img.dataset.srcOff) img.src = img.dataset.srcOff;
                img.classList.toggle('is-on', isOn);
                img.classList.toggle('is-off', !isOn);
            });
        }

        // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö "payload ‡∏•‡πâ‡∏ß‡∏ô" ‡πÄ‡∏ä‡πà‡∏ô { "ductfan":[false], "exhaustfan":[true] }
        function handleLooseStatePayload(obj) {
            if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return;
            Object.entries(obj).forEach(([alias, val]) => {
                let v = val;
                if (Array.isArray(v)) v = v.length ? v[0] : null;
                if (typeof v === 'string') {
                    const s = v.trim().toLowerCase();
                    if (['true', 'on', '1'].includes(s)) v = true;
                    else if (['false', 'off', '0'].includes(s)) v = false;
                    else if (!Number.isNaN(Number(v))) v = Number(v);
                }
                DEVICE_STATE[alias] = v;
                updateImagesByAlias(alias, v);
                document.dispatchEvent(new CustomEvent('ssbbox:state', {
                    detail: { alias, value: v, topic: '' }
                }));
            });
        }
    </script>

    <!-- ================= ANTI-RACE SWITCH ================= -->
    <script>
        (function () {
            function log(...a) { console.log("[SW]", ...a); }
            window.SSB_SWITCH_TOPICS = window.SSB_SWITCH_TOPICS || new Set();

            // subscribe state topic ‡∏Ç‡∏≠‡∏á‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå
            function subscribeStateTopic(alias) {
                const t = `ssb-box/switch/${alias}/state`;
                window.SSB_SWITCH_TOPICS.add(t);
                if (typeof safeSubscribe === 'function') { try { safeSubscribe([t]); } catch { } }
            }

            // ================= pending control =================
            // - confirmedModes: ‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (on/off)
            // - pendingTimers:  ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°
            // - pendingSeq:     ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ß (token ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á valid)
            // - desiredMap:     ‡∏à‡∏≥ "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î pending ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
            const confirmedModes = new Map(), pendingTimers = new Map(), pendingSeq = new Map();
            const desiredMap = new Map(); // üÜï alias -> { val:boolean, token:number }
            const PENDING_MS = 5000;

            function getPrevChecked(alias, fallback) {
                if (typeof DEVICE_STATE?.[alias] !== 'undefined') return !!DEVICE_STATE[alias];
                if (confirmedModes.has(alias)) return confirmedModes.get(alias) === 'on';
                return fallback ?? false;
            }

            function bindAllSwitches() {
                document.querySelectorAll('.ssbbox-switch[data-alias]').forEach(el => {
                    const alias = el.dataset.alias;
                    subscribeStateTopic(alias);

                    // sync ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å DEVICE_STATE ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    if (typeof DEVICE_STATE?.[alias] !== 'undefined') {
                        el.checked = !!DEVICE_STATE[alias];
                        confirmedModes.set(alias, el.checked ? 'on' : 'off');
                    }

                    // ====== ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ "‡∏Å‡∏î" ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ======
                    el.addEventListener('change', () => {
                        const desired = el.checked; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

                        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ backend (MQTT ‡∏ú‡πà‡∏≤‡∏ô publishCmd)
                        if (!(window.publishCmd && window.publishCmd(alias, desired))) {
                            // ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‚Üí ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            el.checked = getPrevChecked(alias, !desired);
                            return;
                        }

                        // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏° (pending)
                        el.disabled = true;                 // ‚õî ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏ã‡πâ‡∏≥
                        el.classList.add('is-pending');     // ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏™‡πà‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠

                        const wrap = el.closest('.switch-inline');
                        wrap?.classList.add('is-pending');  // ‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å (‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å label/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö ‡πÜ)

                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï token ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ß
                        const token = (pendingSeq.get(alias) || 0) + 1;
                        pendingSeq.set(alias, token);

                        // üÜï ‡∏à‡∏≥ "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á" ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≠‡∏ô state ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                        desiredMap.set(alias, { val: desired, token });

                        const prevChecked = getPrevChecked(alias, !desired);

                        // ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏° ‚Üí ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤ + ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
                        const timer = setTimeout(() => {
                            if (pendingSeq.get(alias) !== token) return; // ‡∏°‡∏µ state ‡πÅ‡∏•‡πâ‡∏ß/‡∏°‡∏µ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
                            el.checked = prevChecked;
                            el.classList.remove('is-pending');
                            el.disabled = false;
                            wrap?.classList.remove('is-pending');
                            confirmedModes.set(alias, prevChecked ? 'on' : 'off');
                            desiredMap.delete(alias); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
                        }, PENDING_MS);

                        pendingTimers.set(alias, { timer, token, prevChecked });
                    });
                });
            }

            // ====== sync ‡∏à‡∏≤‡∏Å state ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ "‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á" ======
            document.addEventListener('ssbbox:state', e => {
                const { alias, value } = e.detail || {}; if (!alias) return;

                const want = desiredMap.get(alias);    // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ß‡πâ
                const hasPending = pendingSeq.has(alias);

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ pending ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ "‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á" ‚Üí ‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô, ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏î pending
                if (hasPending && want && (!!value !== !!want.val)) {
                    DEVICE_STATE[alias] = !!value; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô UI
                    return;
                }

                // ‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÑ‡∏°‡πà‡∏°‡∏µ pending ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á ‚Üí ‡∏õ‡∏•‡∏î pending ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                document.querySelectorAll(`.ssbbox-switch[data-alias="${alias}"]`).forEach(el => {
                    el.checked = !!value;
                    el.classList.remove('is-pending');
                    el.disabled = false;

                    const wrap = el.closest('.switch-inline');
                    wrap?.classList.remove('is-pending');
                });

                // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤/‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô/‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
                if (pendingTimers.get(alias)?.timer) clearTimeout(pendingTimers.get(alias).timer);
                pendingTimers.delete(alias);
                pendingSeq.delete(alias);
                desiredMap.delete(alias);

                // ‡∏à‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + mirror ‡πÑ‡∏õ DEVICE_STATE
                confirmedModes.set(alias, value ? 'on' : 'off');
                DEVICE_STATE[alias] = !!value;

                log("state ‚Üê", alias, value);
            });

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindAllSwitches);
            else bindAllSwitches();
        })();
    </script>



    <!-- ================= onPLCUpdate helper ================= -->
    <script>
        // ‡πÉ‡∏´‡πâ backend ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‚Üí ‡∏¢‡∏¥‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ event state ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö WS
        window.onPLCUpdate = ({ alias, power }) => {
            document.dispatchEvent(new CustomEvent('ssbbox:state', {
                detail: { alias, value: !!power, topic: `ssb-box/switch/${alias}/state` }
            }));
        };
    </script>

    <!-- ================= WEBSOCKET (final) ================= -->
    <script>
        const WS_URL = "wss://skin-trackback-tanks-chemical.trycloudflare.com/mqtt";
        let ws, retry;

        /* ---------------- helpers ---------------- */
        const parseMaybe = v => {
            if (typeof v === 'string') { try { return JSON.parse(v); } catch { } }
            return v;
        };

        // ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î: ‡πÉ‡∏´‡πâ‡∏°‡∏µ OBJECT ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠
        window.DEVICE_STATE = window.DEVICE_STATE || Object.create(null);
        window.MODE_STATE = window.MODE_STATE || Object.create(null);

        // ‡πÉ‡∏ä‡πâ toBool ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô toB (‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏ä‡∏∑‡πà‡∏≠)
        const toB = (typeof window.toBool === 'function')
            ? window.toBool
            : function (v) {
                if (typeof v === 'boolean') return v;
                if (typeof v === 'number') return v !== 0;
                if (typeof v === 'string') {
                    const s = v.trim().toLowerCase();
                    if (['true', 'on', '1'].includes(s)) return true;
                    if (['false', 'off', '0'].includes(s)) return false;
                    const n = Number(s); if (!Number.isNaN(n)) return n !== 0;
                }
                return !!v;
            };

        // global subscribe ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
        function safeSubscribe(topics) {
            try { ws?.send(JSON.stringify({ action: "subscribe", topics })); } catch { }
            try { ws?.send(JSON.stringify({ subscribe: topics })); } catch { }
            try { ws?.send(JSON.stringify({ subs: topics })); } catch { }
            try { topics.forEach(t => ws?.send(JSON.stringify({ action: "subscribe", topic: t }))); } catch { }
        }

        // global publish ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á MQTT ‡∏ú‡πà‡∏≤‡∏ô WS
        function safePublish(topic, payload) {
            try {
                if (!window.ws || ws.readyState !== 1) return false;
                const payloadStr = (typeof payload === 'string') ? payload : JSON.stringify(payload);
                ws.send(JSON.stringify({ topic, payload: payloadStr }));
                return true;
            } catch {
                return false;
            }
        }

        // helper: alias ‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå"
        function isSwitchAlias(alias) {
            if (!alias) return false;
            return alias.includes('fan') || alias === 'aircon' || alias === 'humidifier';
        }

        // apply snapshot map: { alias:any, ... }  (‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚Üí boolean, ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤)
        // ‚úÖ ‡πÅ‡∏ñ‡∏°: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ selection ‡πÉ‡∏ô snapshot ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° MODE ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        function applySnapshotData(map) {
            if (!map || typeof map !== 'object') return;

            // --- ‡∏î‡∏∂‡∏á selection ‡∏à‡∏≤‡∏Å snapshot ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ---
            if ('selection' in map) {
                const sel = Array.isArray(map.selection) ? Number(map.selection[0]) : Number(map.selection);
                if (!Number.isNaN(sel)) {
                    // ‡πÉ‡∏ä‡πâ handler ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï MODE button + label)
                    handleModeState({ selection: [sel] });
                    // mirror ‡∏•‡∏á MODE_STATE ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
                    window.MODE_STATE = window.MODE_STATE || Object.create(null);
                    MODE_STATE.selection = sel;
                }
            }

            // --- ‡πÑ‡∏•‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πà‡∏•‡∏∞ alias ---
            Object.entries(map).forEach(([alias, raw]) => {
                if (alias === 'selection') return; // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

                const val = isSwitchAlias(alias) ? toB(raw) : raw;
                DEVICE_STATE[alias] = val;

                if (isSwitchAlias(alias)) updateImagesByAlias(alias, val);

                document.dispatchEvent(new CustomEvent('ssbbox:state', {
                    detail: { alias, value: val, topic: '' }
                }));
            });
        }


        // state with topic = ssb-box/(lamp|switch)/<alias>/state, payload = JSON-string {"<alias>":[true]}
        function applyTopicState(topic, payload) {
            const parts = String(topic || '').split('/'); // ['ssb-box','lamp','ductfan','state']
            if (parts.length < 4 || parts[0] !== 'ssb-box') return false;
            if (!['lamp', 'switch'].includes(parts[1]) || parts[3] !== 'state') return false;

            const alias = parts[2];
            let p = parseMaybe(payload);

            let raw;
            if (p && typeof p === 'object') {
                if (alias in p) raw = Array.isArray(p[alias]) ? p[alias][0] : p[alias];
                else if ('value' in p) raw = Array.isArray(p.value) ? p.value[0] : p.value;
                else raw = p;
            } else {
                raw = p;
            }

            const val = toB(raw);
            DEVICE_STATE[alias] = val;
            updateImagesByAlias(alias, val);
            document.dispatchEvent(new CustomEvent('ssbbox:state', {
                detail: { alias, value: val, topic }
            }));
            return true;
        }

        // ---------- MODE helpers ----------
        function modeAliasFromTopic(topic) {
            const p = String(topic || '').split('/'); // ['ssb-box','mode','<alias>','state']
            return (p.length >= 4 && p[0] === 'ssb-box' && p[1] === 'mode' && p[3] === 'state') ? p[2] : null;
        }

        function parseModePayload(alias, payload) {
            let v = payload;
            if (typeof v === 'string') { try { v = JSON.parse(v); } catch { } }
            if (Array.isArray(v)) return v.length ? v[0] : null;
            if (v && typeof v === 'object') {
                if (alias in v) return Array.isArray(v[alias]) ? v[alias][0] : v[alias];
                if ('selection' in v) return Array.isArray(v.selection) ? v.selection[0] : v.selection;
                if ('value' in v) return Array.isArray(v.value) ? v.value[0] : v.value;
                const ks = Object.keys(v);
                if (ks.length === 1) { let t = v[ks[0]]; return Array.isArray(t) ? t[0] : t; }
                return v;
            }
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                if (['true', 'on', '1'].includes(s)) return true;
                if (['false', 'off', '0'].includes(s)) return false;
                const n = Number(s); if (!Number.isNaN(n)) return n;
            }
            return v;
        }

        function applyModeState(topic, payload) {
            const alias = modeAliasFromTopic(topic);
            if (!alias) return false;

            const val = parseModePayload(alias, payload);
            MODE_STATE[alias] = val;

            // ‡∏û‡∏¥‡πÄ‡∏®‡∏©: selection ‚Üí ‡πÉ‡∏´‡πâ UI ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å state ‡∏à‡∏£‡∏¥‡∏á
            if (alias === 'selection') {
                handleModeState(payload); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏î‡∏¥‡∏° (minify + ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô modeRaw/modeLabel + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°)
            }

            // broadcast event ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
            document.dispatchEvent(new CustomEvent('ssbbox:mode', {
                detail: { alias, value: val, topic }
            }));
            return true;
        }

        /* ---------------- connect ---------------- */
        function connect() {
            clearTimeout(retry);
            try { ws = new WebSocket(WS_URL); window.ws = ws; } catch { retry = setTimeout(connect, 2000); return; }

            ws.onopen = () => {
                const extra = Array.from(window.SSB_SWITCH_TOPICS || []);
                safeSubscribe([
                    "ssb-box/#",
                    "ssb-box/sensor",
                    "ssb-box/lamp/+/state",
                    "ssb-box/switch/+/state",
                    "ssb-box/mode/+/state",
                    ...extra
                ]);
                console.log("‚úÖ WS connected");
            };

            ws.onclose = () => { window.ws = null; retry = setTimeout(connect, 1500); };

            ws.onmessage = (evt) => {
                let m = evt.data;
                if (typeof m === 'string') { try { m = JSON.parse(m); } catch { } }

                // ===== A) ‡∏Å‡∏£‡∏ì‡∏µ "‡πÑ‡∏°‡πà‡∏°‡∏µ topic" (payload-only) =====
                if (m && typeof m === 'object' && !('topic' in m)) {
                    // ‡∏î‡∏∂‡∏á‡πÅ‡∏Å‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô payload ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô root)
                    const obj = (m.payload && typeof m.payload === 'object') ? m.payload : m;

                    // 1) Snapshot: { action:'snapshot', data:{...} }
                    if (obj && obj.action === 'snapshot' && obj.data && typeof obj.data === 'object') {
                        applySnapshotData(obj.data);
                        return;
                    }

                    // 2) Mode selection: { selection:[N] }
                    if (obj && typeof obj === 'object' && 'selection' in obj) {
                        handleModeState(obj); // minify + ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô modeRaw/modeLabel + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°/‡∏™‡∏µ
                        MODE_STATE.selection = Array.isArray(obj.selection) ? obj.selection[0] : obj.selection;
                        return;
                    }

                    // 3) ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå/‡πÅ‡∏•‡∏°‡∏õ‡πå‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏ß‡∏° ‡πÜ: { ductfan:true, exhaustfan:false, ... }
                    if (obj && typeof obj === 'object') {
                        handleLooseStatePayload(obj); // ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                        return;
                    }
                }

                // ===== B) ‡∏Å‡∏£‡∏ì‡∏µ "‡∏°‡∏µ topic" ‡∏õ‡∏Å‡∏ï‡∏¥ =====
                if (m && typeof m === 'object' && 'topic' in m) {
                    const topic = String(m.topic || '');
                    const p = parseMaybe(m.payload);

                    // 1) ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ssb-box/mode/+/state
                    if (applyModeState(topic, m.payload)) return;

                    // 2) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sensor ‡∏£‡∏ß‡∏°
                    if (topic === 'ssb-box/sensor' && p && typeof p === 'object') {
                        handleSensorPayload(p);
                        return;
                    }

                    // 3) ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå/‡πÅ‡∏•‡∏°‡∏õ‡πå‡∏£‡∏≤‡∏¢ alias: ssb-box/(lamp|switch)/<alias>/state
                    if (applyTopicState(topic, m.payload)) return;
                }
            };
        }

        /* --------- ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô realtime ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ --------- */
        setGauge(document.getElementById('gAir'), 30);
        setGauge(document.getElementById('gRH'), 55);
        setGauge(document.getElementById('gCO2'), 1200);
        setGauge(document.getElementById('gLight'), 1);

        connect();

        /* ---------------- ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (SEND) ----------------
           ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:
           topic: ssb-box/switch/<alias>/cmd
           payload: ‡∏™‡∏ï‡∏£‡∏¥‡∏á JSON ‡πÄ‡∏ä‡πà‡∏ô "{\"ductfan\":[true]}"
        --------------------------------------------------- */
        function publishCmd(alias, desired) {
            const topic = `ssb-box/switch/${alias}/cmd`;
            const payloadStr = JSON.stringify({ [alias]: [desired] });
            if (!window.ws || ws.readyState !== 1) { console.warn("[SEND] ws not ready"); return false; }
            const frame = { topic, payload: payloadStr };
            ws.send(JSON.stringify(frame));
            return true;
        }
    </script>



    <script>
        /* ====== PILL (data-*) MODULE ‚Äì place after WEBSOCKET(final) ====== */
        (function () {
            function init() { document.querySelectorAll('.pill[data-alias]').forEach(mount); }

            function mount(el) {
                const label = el.querySelector('[data-label]') || el.querySelector('span');

                const alias = (el.dataset.alias || '').trim();                 // ‡πÇ‡∏´‡∏°‡∏î ‡πÄ‡∏ä‡πà‡∏ô ductfan
                const switchKey = (el.dataset.switchKey || (alias + 'of')).trim(); // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‡πÄ‡∏ä‡πà‡∏ô ductfanof
                const prefix = (el.dataset.prefix || 'ssb-box').trim();         // ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                const cmdTopic = (el.dataset.cmdTopic || `${prefix}/switch/${switchKey}/cmd`).trim();
                const stateAlias = (el.dataset.stateAlias || alias).trim();         // ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ssbbox:state

                // ‡∏Ñ‡∏•‡∏¥‡∏Å -> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                el.style.cursor = 'pointer';
                el.addEventListener('click', () => {
                    const desired = !(el.dataset._sw === 'true');                      // toggle local
                    const payload = JSON.stringify({ [switchKey]: [desired] });
                    const ok = (typeof safePublish === 'function') && safePublish(cmdTopic, payload);
                    if (!ok) { console.warn('[pill] safePublish not ready'); return; }
                    // optimistic ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏£‡∏≠ state ‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤ overwrite)
                    el.dataset._sw = String(desired);
                    // ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ pill ‡∏ï‡∏≤‡∏° ON/OFF ‚Äî pill ‡πÅ‡∏™‡∏î‡∏á "‡πÇ‡∏´‡∏°‡∏î" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                });

                // ‡πÇ‡∏´‡∏°‡∏î 0/1/2/3 -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                document.addEventListener('ssbbox:mode', (e) => {
                    const { alias: a, value } = e.detail || {};
                    if (a !== alias) return;
                    renderMode(el, label, value);
                });

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ event ‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡∏Ç‡∏≠‡∏á alias ‡∏ô‡∏µ‡πâ -> ‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô toggle
                document.addEventListener('ssbbox:state', (e) => {
                    const { alias: a, value } = e.detail || {};
                    if (a !== stateAlias) return;
                    el.dataset._sw = String(!!value);
                });
            }

            function renderMode(el, label, val) {
                const n = Number(Array.isArray(val) ? val[0] : val);
                el.classList.remove('auto', 'manual', 'task', 'off', 'unknown');
                switch (n) {
                    case 0: el.classList.add('manual'); label.textContent = 'Manual'; break;
                    case 1: el.classList.add('auto'); label.textContent = 'Auto'; break;
                    case 2: el.classList.add('task'); label.textContent = 'Task'; break;
                    case 3: el.classList.add('off'); label.textContent = 'Off'; break;
                    default: el.classList.add('unknown'); label.textContent = 'Unknown';
                }
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
            else init();
        })();
    </script>











    <!-- ================= THEME & TABS ================= -->
    <script>
        (function () {
            const BTN = document.querySelector('.darklight');
            function setBtnLabel() {
                const s = localStorage.getItem('themeIcon') || 'dark';
                if (BTN) BTN.textContent = (s === 'dark') ? 'üåô Dark' : '‚òÄÔ∏è Light';
            }
            if (BTN) {
                BTN.addEventListener('click', () => {
                    const cur = localStorage.getItem('themeIcon') || 'dark';
                    const next = (cur === 'dark') ? 'light' : 'dark';
                    localStorage.setItem('themeIcon', next);
                    setBtnLabel();
                });
            }
            setBtnLabel();

            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.style.cursor = 'pointer';
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    if (tab.dataset.href) window.location.href = tab.dataset.href;
                });
            });
        })();
    </script>

    <!-- ================= SNAPSHOT (sensor) ================= -->
    <script>
        const SNAP_KEY = 'ssbbox:last-sensor', SNAP_MAX_AGE_MS = 0;
        function saveSnapshot(payload) {
            try { localStorage.setItem(SNAP_KEY, JSON.stringify({ ts: Date.now(), data: payload })); } catch { }
        }
        function loadSnapshot() {
            try {
                const raw = localStorage.getItem(SNAP_KEY); if (!raw) return null;
                const snap = JSON.parse(raw); if (!snap || !snap.data) return null;
                if (SNAP_MAX_AGE_MS > 0 && Date.now() - (snap.ts || 0) > SNAP_MAX_AGE_MS) return null;
                return snap.data;
            } catch { return null; }
        }
        (function () { const snap = loadSnapshot(); if (snap) handleSensorPayload(snap); })();
    </script>



    <!-- ================= Mode  ================= -->
    <script>
        const MODE_LABEL = { 0: 'MANUAL', 1: 'AUTO', 2: 'TASK' };

        // ---------- pending control ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MODE ----------
        let MODE_PENDING = null, MODE_TOKEN = 0, MODE_TIMER = null;
        const MODE_PENDING_MS = 5000;

        function setModePending(flag) {
            const btn = document.querySelector('#modeDropdown > button');
            if (!btn) return;
            if (flag) {
                btn.classList.add('is-pending');
                btn.setAttribute('disabled', 'disabled');
            } else {
                btn.classList.remove('is-pending');
                btn.removeAttribute('disabled');
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤ mode ‡∏à‡∏£‡∏¥‡∏á (‡∏õ‡∏∏‡πà‡∏° + pill + label)
        function updateModeUI(sel) {
            const btn = document.querySelector('#modeDropdown > button');
            const pill = document.getElementById('statusPill');
            const pillLabel = document.getElementById('statusLabel');

            // === ‡∏õ‡∏∏‡πà‡∏° MODE: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î ===
            if (btn && sel !== undefined) {
                btn.textContent = "MODE: " + ({ 0: 'MANUAL', 1: 'AUTO', 2: 'TASK' }[sel] ?? sel);
                btn.classList.remove('mode-auto', 'mode-manual', 'mode-task', 'mode-off');
                if (sel === 1) btn.classList.add('mode-auto');
                else if (sel === 0) btn.classList.add('mode-manual');
                else if (sel === 2) btn.classList.add('mode-task');
                else btn.classList.add('mode-off');
            }



        }

        // üîÅ ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö state ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å topic ssb-box/mode/selection/state
        function handleModeState(payload) {
            let rawMinified = payload;
            let sel;
            try {
                const obj = (typeof payload === 'string') ? JSON.parse(payload) : payload;
                sel = Array.isArray(obj?.selection) ? obj.selection[0] : undefined;
                rawMinified = JSON.stringify({ selection: [sel] }); // {"selection":[N]}
            } catch {
                const m = String(payload || '').match(/"selection"\s*:\s*\[\s*(\d+)\s*\]/);
                if (m) {
                    sel = parseInt(m[1], 10);
                    rawMinified = `{"selection":[${sel}]}`;
                }
            }

            // ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏≤ raw + label ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            document.getElementById('modeRaw')?.replaceChildren(rawMinified);
            document.getElementById('modeLabel')?.replaceChildren(
                (sel in MODE_LABEL) ? MODE_LABEL[sel] : (sel !== undefined ? `UNKNOWN(${sel})` : '-')
            );

            // üÜï ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ pill ‡∏ï‡∏≤‡∏° state ‡∏à‡∏£‡∏¥‡∏á
            if (sel !== undefined) updateModeUI(sel);

            // üÜï ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ pending ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á ‚Üí ‡∏õ‡∏•‡∏î pending
            if (MODE_PENDING && sel !== undefined) {
                if (sel === MODE_PENDING.val) {
                    setModePending(false);
                    MODE_PENDING = null;
                    if (MODE_TIMER) { clearTimeout(MODE_TIMER); MODE_TIMER = null; }
                }
            }
        }

        // ---------- bind dropdown ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á cmd + ‡πÄ‡∏Ç‡πâ‡∏≤ pending ----------
        (function bindModeDropdown() {
            const root = document.getElementById('modeDropdown');
            if (!root) return;

            const btn = root.querySelector('button');
            // ‡πÉ‡∏ä‡πâ Bootstrap dropdown instance ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å
            let dd = null;
            try { dd = bootstrap.Dropdown.getOrCreateInstance(btn); } catch { }

            root.querySelectorAll('.dropdown-item').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const val = parseInt(a.dataset.val, 10);
                    const payload = `{"selection":[${val}]}`; // ‡πÑ‡∏°‡πà‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ

                    const ok = (typeof safePublish === 'function')
                        ? safePublish("ssb-box/mode/selection/cmd", payload)
                        : false;

                    if (!ok) {
                        console.warn("[MODE] ws not ready, cannot publish");
                        return;
                    }

                    // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°
                    MODE_TOKEN += 1;
                    MODE_PENDING = { val, token: MODE_TOKEN };
                    setModePending(true);
                    if (dd) dd.hide();

                    // ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‚Üí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏â‡∏¢ ‡πÜ (‡∏Ñ‡∏á UI ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
                    if (MODE_TIMER) clearTimeout(MODE_TIMER);
                    MODE_TIMER = setTimeout(() => {
                        if (MODE_PENDING && MODE_PENDING.token === MODE_TOKEN) {
                            setModePending(false);
                            MODE_PENDING = null;
                            MODE_TIMER = null;
                        }
                    }, MODE_PENDING_MS);
                });
            });
        })();
    </script>









</body>

</html>